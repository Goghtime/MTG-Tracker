<!-- templates/account.html -->

{% extends "layout.html" %}

{% block content %}
<h2 class="text-center my-4">My Profile</h2>
<p>Welcome, {{ current_user.username }}! This is your profile page.</p>

<!-- Tab Navigation -->
<ul class="nav nav-tabs justify-content-center" id="accountTabs">
  <li class="nav-item">
    <a class="nav-link active" id="active-roster-tab" data-toggle="tab" href="#active-roster">Active Roster</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="retired-roster-tab" data-toggle="tab" href="#retired-roster">Retired Roster</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="delete-commander-tab" data-toggle="tab" href="#delete-commander">Delete Commander</a>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
  <!-- Active Roster -->
  <div class="tab-pane fade show active" id="active-roster">
    <h3 class="text-center my-3">Active Roster</h3>
    <div class="commander-search text-center">
      <input type="text" id="commander-search" class="form-control mb-3 w-50 mx-auto" placeholder="Search for a commander...">
      <div id="search-results"></div>
    </div>
    <ul class="list-group mb-4">
      {% for commander in active_commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <div>
          Wins: {{ commander.wins }} | Losses: {{ commander.losses }}
        </div>
        <button type="button" class="btn btn-danger" onclick="toggleCommanderStatus({{ commander.id }}, false)">Retire</button>
      </li>
      {% else %}
      <p class="text-center">No active commanders in your roster.</p>
      {% endfor %}
    </ul>
  </div>

  <!-- Retired Roster -->
  <div class="tab-pane fade" id="retired-roster">
    <h3 class="text-center my-3">Retired Roster</h3>
    <ul class="list-group mb-4">
      {% for commander in retired_commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <div>
          Wins: {{ commander.wins }} | Losses: {{ commander.losses }}
        </div>
        <button type="button" class="btn btn-success" onclick="toggleCommanderStatus({{ commander.id }}, true)">Reactivate</button>
      </li>
      {% else %}
      <p class="text-center">No retired commanders in your roster.</p>
      {% endfor %}
    </ul>
  </div>

  <!-- Delete Commander -->
  <div class="tab-pane fade" id="delete-commander">
    <h3 class="text-center my-3">Delete Commander</h3>
    <ul class="list-group mb-4">
      {% for commander in commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <button type="button" class="btn btn-danger" onclick="deleteCommander({{ commander.id }})">Delete</button>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
<script>
  $(document).ready(function() {
    var $searchResults = $('#search-results');
    var csrfToken = $('meta[name="csrf-token"]').attr('content');

    $('#commander-search').on('input', function() {
      var searchQuery = $(this).val();
      if (searchQuery.length >= 3) {
        $.ajax({
          url: '/search_commanders?q=' + encodeURIComponent(searchQuery),
          type: 'GET',
          success: function(data) {
            var items = [];
            $.each(data, function(i, commander) {
              var imageUrl = commander.image_uris ? commander.image_uris.normal : 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/SNice.svg/1200px-SNice.svg.png';
              items.push('<button type="button" class="commander-item" data-name="' + commander.name +
                '" data-color-identity="' + commander.color_identity.join(', ') + 
                '" data-image-url="' + imageUrl + '">' + 
                commander.name + '</button>');
            });
            $searchResults.html(items.join(''));
          },
          error: function(error) {
            console.log(error);
          }
        });
      } else {
        $searchResults.empty();
      }
    });

    $searchResults.on('click', '.commander-item', function() {
      var commanderName = $(this).data('name');
      var commanderColorIdentity = $(this).data('color-identity');
      var commanderImageUrl = $(this).data('image-url');

      $.ajax({
        url: '/add_commander',
        type: 'POST',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({ 
          name: commanderName,
          color_identity: commanderColorIdentity,
          image_url: commanderImageUrl
        }),
        headers: { 'X-CSRFToken': csrfToken },
        success: function(response) {
          alert('Commander added successfully!');
          $searchResults.empty();
        },
        error: function(error) {
          console.log(error);
        }
      });
    });
  });

  function toggleCommanderStatus(commanderId) {
    var csrfToken = '{{ csrf_token() }}'; // Get the CSRF token
    $.ajax({
      url: '/toggle_commander/' + commanderId,
      type: 'POST',
      headers: { 'X-CSRFToken': csrfToken }, // Include CSRF token
      success: function(response) {
        alert('Commander status toggled successfully!');
        location.reload(); // Reload the page
      },
      error: function(error) {
        console.log('Error toggling commander status:', error);
      }
    });
  }

  function deleteCommander(commanderId) {
    var csrfToken = '{{ csrf_token() }}'; // Get the CSRF token
    $.ajax({
      url: '/delete_commander/' + commanderId,
      type: 'POST',
      headers: { 'X-CSRFToken': csrfToken }, // Include CSRF token
      success: function(response) {
        alert('Commander deleted successfully!');
        location.reload(); // Reload the page
      },
      error: function(error) {
        console.log('Error deleting commander:', error);
      }
    });
  }
</script>

<script>
  $(document).ready(function() {
    // Existing JavaScript code for commander search and actions

    // Tab switch handler
    $('#accountTabs a').on('click', function (e) {
      e.preventDefault();
      $(this).tab('show');
    });
  });
</script>
{% endblock %}
<!-- templates/account.html -->

{% extends "layout.html" %}

{% block content %}
<h2 class="text-center my-4">My Profile</h2>
<p>Welcome, {{ current_user.username }}! This is your profile page.</p>

<!-- Tab Navigation -->
<ul class="nav nav-tabs justify-content-center" id="accountTabs">
  <li class="nav-item">
    <a class="nav-link active" id="active-roster-tab" data-toggle="tab" href="#active-roster">Active Roster</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="retired-roster-tab" data-toggle="tab" href="#retired-roster">Retired Roster</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="delete-commander-tab" data-toggle="tab" href="#delete-commander">Delete Commander</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings">Settings</a>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
  <!-- Active Roster -->
  <div class="tab-pane fade show active" id="active-roster">
    <h3 class="text-center my-3">Active Roster</h3>
    <div class="commander-search text-center">
      <input type="text" id="commander-search" class="form-control mb-3 w-50 mx-auto" placeholder="Search for a commander...">
      <div id="search-results"></div>
    </div>
    <ul class="list-group mb-4">
      {% for commander in active_commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <div>
          Wins: {{ commander.wins }} | Losses: {{ commander.losses }}
        </div>
        <button type="button" class="btn btn-danger" onclick="toggleCommanderStatus({{ commander.id }}, false)">Retire</button>
      </li>
      {% else %}
      <p class="text-center">No active commanders in your roster.</p>
      {% endfor %}
    </ul>
  </div>

  <!-- Retired Roster -->
  <div class="tab-pane fade" id="retired-roster">
    <h3 class="text-center my-3">Retired Roster</h3>
    <ul class="list-group mb-4">
      {% for commander in retired_commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <div>
          Wins: {{ commander.wins }} | Losses: {{ commander.losses }}
        </div>
        <button type="button" class="btn btn-success" onclick="toggleCommanderStatus({{ commander.id }}, true)">Reactivate</button>
      </li>
      {% else %}
      <p class="text-center">No retired commanders in your roster.</p>
      {% endfor %}
    </ul>
  </div>

  <!-- Delete Commander -->
  <div class="tab-pane fade" id="delete-commander">
    <h3 class="text-center my-3">Delete Commander</h3>
    <ul class="list-group mb-4">
      {% for commander in commanders %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ commander.name }}</strong>
          <div>Color Identity: {{ commander.color_identity }}</div>
          <div>Mana Cost: {{ commander.mana_cost }}</div>
        </div>
        <button type="button" class="btn btn-danger" onclick="deleteCommander({{ commander.id }})">Delete</button>
      </li>
      {% endfor %}
    </ul>
  </div>

<!-- Settings Tab -->
<div class="tab-pane fade" id="settings">
  <h3 class="text-center my-3">Account Settings</h3>
  <div class="row justify-content-center">
      <!-- Password Update Form Column -->
      <div class="col-md-6">
          <form method="POST" action="{{ url_for('update_password') }}">
              <div class="mb-3">
                  <label for="currentPassword" class="form-label">Current Password</label>
                  <input type="password" class="form-control" id="currentPassword" name="current_password" required>
              </div>
              <div class="mb-3">
                  <label for="newPassword" class="form-label">New Password</label>
                  <input type="password" class="form-control" id="newPassword" name="new_password" required>
              </div>
              <div class="mb-3">
                  <label for="confirmPassword" class="form-label">Confirm New Password</label>
                  <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
              </div>
              <button type="submit" class="btn btn-primary">Update Password</button>
          </form>
      </div>

<!-- Avatar Upload Column -->
<div class="col-md-6 avatar-section">
  <div class="current-avatar mb-3">
      {% if current_user.avatar %}
          <img src="{{ url_for('static', filename=current_user.avatar[8:]) }}" alt="User Avatar" class="avatar-img rounded-circle border">
      {% else %}
          <img src="{{ url_for('static', filename='uploads/default.png') }}" alt="User Avatar" class="avatar-img rounded-circle border"> 
      {% endif %}
  </div>
  <form id="avatarUploadForm" method="POST" action="{{ url_for('upload_avatar') }}" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="mb-3">
          <label for="avatar" class="form-label">Upload Avatar</label>
          <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
      </div>
      <button type="submit" class="btn btn-secondary">Upload Avatar</button>
  </form>
</div>
<!-- Other column for password change... -->
</div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
<script>
  $(document).ready(function() {
    var $searchResults = $('#search-results');
    var csrfToken = $('meta[name="csrf-token"]').attr('content');

 // Commander Search Functionality
 $('#commander-search').on('input', function() {
    var searchQuery = $(this).val();
    if (searchQuery.length >= 3) {
        var scryfallApiUrl = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(searchQuery)}+type:legendary+is:commander`;

        $.ajax({
            url: scryfallApiUrl,
            type: 'GET',
            success: function(data) {
                var items = [];
                data.data.forEach(function(card) {
                    var name = card.name;
                    var manaCost = card.mana_cost || '';
                    var cmc = card.cmc || 0;
                    var imageUrl = card.image_uris ? card.image_uris.normal : 'defaultImageUrl';
                    var colorIdentity = card.color_identity.join(', ') || '';

                    items.push(`<button type="button" class="commander-item" data-name="${name}" data-mana-cost="${manaCost}" data-image-url="${imageUrl}" data-cmc="${cmc}" data-color-identity="${colorIdentity}">${name}</button>`);
                });
                $searchResults.html(items.join(''));
            },
            error: function(error) {
                console.log(error);
            }
        });
    } else {
        $searchResults.empty();
    }
});

    // Commander Add Functionality
    $searchResults.on('click', '.commander-item', function() {
    var commanderName = $(this).data('name');
    var commanderColorIdentity = $(this).data('color-identity');
    var commanderImageUrl = $(this).data('image-url');
    var commanderManaCost = $(this).data('mana-cost');
    var commanderCmc = $(this).data('cmc');

    $.ajax({
        url: '/add_commander',
        type: 'POST',
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify({ 
            name: commanderName,
            color_identity: commanderColorIdentity,
            image_url: commanderImageUrl,
            mana_cost: commanderManaCost,
            cmc: commanderCmc
        }),
        headers: { 'X-CSRFToken': csrfToken },
        success: function(response) {
            alert('Commander added successfully!');
            window.location.reload(); // Reload the page
        },
        error: function(error) {
            console.log(error);
        }
    });
});
  });

  function toggleCommanderStatus(commanderId) {
    var csrfToken = '{{ csrf_token() }}'; // Get the CSRF token
    $.ajax({
      url: '/toggle_commander/' + commanderId,
      type: 'POST',
      headers: { 'X-CSRFToken': csrfToken }, // Include CSRF token
      success: function(response) {
        alert('Commander status toggled successfully!');
        location.reload(); // Reload the page
      },
      error: function(error) {
        console.log('Error toggling commander status:', error);
      }
    });
  }

  function deleteCommander(commanderId) {
    var csrfToken = '{{ csrf_token() }}'; // Get the CSRF token
    $.ajax({
      url: '/delete_commander/' + commanderId,
      type: 'POST',
      headers: { 'X-CSRFToken': csrfToken }, // Include CSRF token
      success: function(response) {
        alert('Commander deleted successfully!');
        location.reload(); // Reload the page
      },
      error: function(error) {
        console.log('Error deleting commander:', error);
      }
    });
  }
</script>

<script>
  $(document).ready(function() {
    // Existing JavaScript code for commander search and actions

    // Tab switch handler
    $('#accountTabs a').on('click', function (e) {
      e.preventDefault();
      $(this).tab('show');
    });
  });
</script>

<script>
  $(document).ready(function() {
      $('#avatarUploadForm').submit(function(e) {
          e.preventDefault(); // Prevent the default form submission
  
          $.ajax({
              url: '/upload_avatar',
              type: 'POST',
              data: new FormData(this),
              processData: false,
              contentType: false,
              beforeSend: function(xhr) {
                  xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token() }}');
              },
              success: function(response) {
                  // Handle success - e.g., show a message, redirect, etc.
              },
              error: function(error) {
                  // Handle error - e.g., display error message
              }
          });
      });
  });
  </script>
  
{% endblock %}
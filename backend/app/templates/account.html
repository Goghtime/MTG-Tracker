<!-- templates/account.html -->

{% extends "layout.html" %}

{% block content %}
<h2>Account Page</h2>
<p>Welcome, {{ current_user.username }}! This is your account page.</p>

<!-- Commander search input and results container -->
<input type="text" id="commander-search" placeholder="Search for a commander...">
<div id="search-results"></div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var $searchResults = $('#search-results');
        var csrfToken = $('meta[name="csrf-token"]').attr('content');

        $('#commander-search').on('input', function() {
            var searchQuery = $(this).val();
            if (searchQuery.length >= 3) {
                $.ajax({
                    url: '/search_commanders?q=' + encodeURIComponent(searchQuery),
                    type: 'GET',
                    success: function(data) {
                        var items = [];
                        $.each(data, function(i, commander) {
                            var imageUrl = commander.image_uris ? commander.image_uris.normal : 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/SNice.svg/1200px-SNice.svg.png';
                            items.push('<button type="button" class="commander-item" data-name="' + commander.name +
                                '" data-color-identity="' + commander.color_identity.join(', ') + 
                                '" data-image-url="' + imageUrl + '">' + 
                                commander.name + '</button>');
                        });
                        $searchResults.html(items.join(''));
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            } else {
                $searchResults.empty();
            }
        });

        $searchResults.on('click', '.commander-item', function() {
            var commanderName = $(this).data('name');
            var commanderColorIdentity = $(this).data('color-identity');
            var commanderImageUrl = $(this).data('image-url');

            $.ajax({
                url: '/add_commander',
                type: 'POST',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({ 
                    name: commanderName,
                    color_identity: commanderColorIdentity,
                    image_url: commanderImageUrl
                }),
                headers: { 'X-CSRFToken': csrfToken },
                success: function(response) {
                    alert('Commander added successfully!');
                    $searchResults.empty();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });
    });

    function deleteCommander(commanderId) {
    var csrfToken = $('meta[name="csrf-token"]').attr('content');
    
    $.ajax({
        url: '/delete_commander/' + commanderId,
        type: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            alert('Commander deleted successfully!');
            location.reload(); // Reload the page
        },
        error: function(error) {
            console.log(error);
        }
    });
}
</script>

<br>
<h3>Current Roster</h3>
<div class="commander-roster">
    {% if commanders %}
        {% for commander in commanders %}
        <div class="commander">
            <h4>{{ commander.name }}</h4>
            <img src="{{ commander.image_url }}" alt="{{ commander.name }}" />
            <button type="button" onclick="deleteCommander({{ commander.id }})">Delete</button>
        </div>
        
        {% endfor %}
    {% else %}
        <p>You have no commanders in your roster.</p>
    {% endif %}
</div>
{% endblock %}
